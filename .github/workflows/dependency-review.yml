name: Dependency Security Scan

on:
  pull_request:
    branches: [main]
    paths:
      - 'pubspec.yaml'
      - 'pubspec.lock'
      - '.github/workflows/dependency-review.yml'
  schedule:
    - cron: '0 0 * * 1'  # Weekly Monday scan
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: write
  security-events: write

jobs:
  dart-dependency-scan:
    name: Flutter dependency security scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable
          cache: true

      - name: Install dependencies
        run: flutter pub get

      - name: Check pubspec.lock exists (BLOCKING)
        run: |
          if [ ! -f pubspec.lock ]; then
            echo "âŒ SECURITY RISK: pubspec.lock is missing"
            echo "Dependencies are not locked - supply chain attack risk"
            exit 1
          fi
          echo "âœ… pubspec.lock present - dependencies are locked"

      - name: Verify no git dependencies (BLOCKING)
        run: |
          if grep -q "git:" pubspec.yaml; then
            echo "âŒ SECURITY RISK: Git dependencies found"
            echo "Git dependencies can be modified without version control"
            grep -A 2 "git:" pubspec.yaml
            exit 1
          else
            echo "âœ… No git dependencies found"
          fi

      - name: Dart analyze for security (BLOCKING)
        run: |
          echo "Running strict Dart analysis..."
          flutter analyze --fatal-infos

      - name: Run pub outdated (WARNING ONLY)
        id: outdated
        continue-on-error: true
        run: |
          echo "Checking for outdated dependencies..."
          flutter pub outdated --json > outdated.json || true
          
          if [ -f outdated.json ]; then
            OUTDATED_COUNT=$(jq '.packages | length' outdated.json 2>/dev/null || echo "0")
            echo "outdated_count=$OUTDATED_COUNT" >> $GITHUB_OUTPUT
            
            if [ "$OUTDATED_COUNT" -gt 0 ]; then
              echo "âš ï¸  Found $OUTDATED_COUNT outdated packages (warning only)"
              flutter pub outdated || true
            else
              echo "âœ… All dependencies are up to date"
            fi
          fi

      - name: Check dependency sources
        run: |
          echo "ðŸ“¦ Verifying dependency sources..."
          echo "Direct dependencies from pub.dev:"
          yq '.dependencies | keys | .[]' pubspec.yaml 2>/dev/null || \
            grep -A 100 "^dependencies:" pubspec.yaml | grep "^  [a-z]" | sed 's/:.*$//' | head -20

      - name: Upload scan results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: dependency-scan-results
          path: |
            outdated.json
          if-no-files-found: ignore

      - name: Summary
        if: always()
        run: |
          echo "## ðŸ”’ Dependency Security Scan Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… **Blocking checks passed:**" >> $GITHUB_STEP_SUMMARY
          echo "- pubspec.lock is committed" >> $GITHUB_STEP_SUMMARY
          echo "- No git dependencies detected" >> $GITHUB_STEP_SUMMARY
          echo "- Dart analysis passed with --fatal-infos" >> $GITHUB_STEP_SUMMARY
          
          if [ -f outdated.json ]; then
            OUTDATED=$(jq '.packages | length' outdated.json 2>/dev/null || echo "0")
            if [ "$OUTDATED" -gt 0 ]; then
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "âš ï¸  **$OUTDATED outdated packages** (non-blocking)" >> $GITHUB_STEP_SUMMARY
            fi
          fi
