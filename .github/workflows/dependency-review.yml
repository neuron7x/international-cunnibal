name: Dependency Review

on:
  # Primary: PR review (best practice for dependency review)
  pull_request:
    branches: [main, develop]
    types: [opened, synchronize, reopened]
  
  # Secondary: Manual trigger for audits
  workflow_dispatch:
    inputs: 
      base_ref:
        description: 'Base reference (branch/commit)'
        required: false
        default: 'main'
      head_ref:
        description: 'Head reference (branch/commit)'
        required: false
        default: 'HEAD'

permissions:
  contents: read
  pull-requests: write  # For PR comments
  security-events: write  # For GitHub Security tab

jobs: 
  dependency-review:
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request' || github.event_name == 'workflow_dispatch'
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with: 
          # Fetch full history for accurate comparison
          fetch-depth: 0

      - name: Dependency review
        id: dependency-review
        uses: actions/dependency-review-action@v4
        continue-on-error: true  # Don't block PR on transient errors
        with:
          fail-on-severity: high
          # Additional production-ready parameters
          deny-licenses: GPL-2.0-only, GPL-2.0-or-later, GPL-3.0-only, GPL-3.0-or-later, AGPL-3.0-only, AGPL-3.0-or-later, LGPL-2.1-only, LGPL-3.0-only  # Block problematic licenses
          fail-on-scopes: runtime, development
          vulnerability-check: true
          license-check: true
          comment-summary-in-pr: true  # Automatic comments
          retry-on-snapshot-warnings: true
          retry-on-snapshot-warnings-timeout: 600
          # Only set refs for manual workflow_dispatch triggers (auto-detected for PRs)
          base-ref: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.base_ref || '' }}
          head-ref: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.head_ref || '' }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Generate dependency snapshot
        if: always()
        run: |
          # Export dependency tree for Dart/Flutter
          if [ -f pubspec.yaml ]; then
            if command -v flutter &> /dev/null; then
              flutter pub deps --json > deps-snapshot.json || echo '{"error": "flutter pub deps failed"}' > deps-snapshot.json
            else
              echo '{"error": "Flutter not available in runner"}' > deps-snapshot.json
            fi
          else
            echo '{"info": "No pubspec.yaml found"}' > deps-snapshot.json
          fi

      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: dependency-review-${{ github.run_id }}
          path: deps-snapshot.json
          retention-days: 90
          if-no-files-found: warn

      - name: Report failure
        if: steps.dependency-review.outcome == 'failure'
        uses: actions/github-script@v7
        with:
          script: |
            // Only comment on PRs, not workflow_dispatch
            if (context.eventName === 'pull_request') {
              await github.rest.issues.createComment({
                ...context.repo,
                issue_number: context.issue.number,
                body: '⚠️ Dependency review failed. Manual audit required.\n\nPlease check the workflow logs for details or ensure Dependency Graph is enabled in repository settings.'
              });
            }
