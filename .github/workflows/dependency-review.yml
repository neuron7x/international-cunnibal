name: Dependency Security Scan

on:
  pull_request:
    branches: [main]
    paths:
      - 'pubspec.yaml'
      - 'pubspec.lock'
  schedule:
    - cron: '0 0 * * 1'  # Weekly scan on Mondays
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: write
  security-events: write

jobs:
  dart-dependency-scan:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable
          cache: true

      - name: Install dependencies
        run: flutter pub get

      - name: Install jq for JSON parsing
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Run pub outdated
        id: outdated
        continue-on-error: true
        run: |
          flutter pub outdated --json > outdated.json
          cat outdated.json

      - name: Check for vulnerable dependencies
        run: |
          echo "Scanning Dart/Flutter dependencies for security issues..."
          
          # Check for critically outdated packages
          if [ -f outdated.json ]; then
            OUTDATED_COUNT=$(jq '.packages | length' outdated.json)
            echo "Found $OUTDATED_COUNT outdated packages"
            
            # Threshold of 20 is based on industry best practices for dependency management
            if [ "$OUTDATED_COUNT" -gt 20 ]; then
              echo "‚ö†Ô∏è  Warning: More than 20 packages are outdated"
              echo "Consider updating dependencies to reduce security risk"
            fi
          fi

      - name: Dart analyze for security
        run: flutter analyze --fatal-infos

      - name: Check pubspec.lock exists
        run: |
          if [ ! -f pubspec.lock ]; then
            echo "‚ùå pubspec.lock is missing - dependencies are not locked"
            exit 1
          fi
          echo "‚úÖ pubspec.lock present - dependencies are locked"

      - name: Verify no git dependencies
        run: |
          # Check for git dependencies in the dependencies section
          if grep -A 50 "^dependencies:" pubspec.yaml | grep -E "^\s+[a-z_]+:\s*$" -A 1 | grep -q "git:"; then
            echo "‚ö†Ô∏è  Warning: Git dependencies found - potential security risk"
            echo "Git dependencies bypass pub.dev security checks and version verification"
            grep -A 50 "^dependencies:" pubspec.yaml | grep -B 1 "git:"
          else
            echo "‚úÖ No git dependencies found"
          fi

      - name: Check for suspicious packages
        run: |
          # List all dependencies
          echo "üì¶ Direct dependencies:"
          # Parse dependencies from pubspec.yaml using grep
          grep -A 100 "^dependencies:" pubspec.yaml | grep -E "^\s+[a-z_][a-z0-9_]*:" | sed 's/:.*//' | sed 's/^  //' | head -20

      - name: Upload scan results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: dependency-scan-results
          path: outdated.json
          if-no-files-found: ignore
