name: Dependency Review

on:
  # Primary: PR review (best practice for dependency review)
  pull_request:
    branches: [main, develop]
    types: [opened, synchronize, reopened]
  
  # Secondary: Manual trigger for audits
  workflow_dispatch:
    inputs: 
      base_ref:
        description: 'Base reference (branch/commit)'
        required: true
        default: 'main'
      head_ref:
        description: 'Head reference (branch/commit)'
        required: true
        default: 'HEAD'

permissions:
  contents: read
  pull-requests: write  # For PR comments

jobs: 
  dependency-review:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with: 
          # Fetch full history for accurate comparison
          fetch-depth: 0

      - name: Dependency review
        uses: actions/dependency-review-action@v4
        with:
          fail-on-severity: high
          # Additional production-ready parameters
          deny-licenses: GPL-2.0-only, GPL-3.0-only  # Block problematic licenses
          fail-on-scopes: runtime, development
          vulnerability-check: true
          license-check: true
          comment-summary-in-pr: true  # Automatic comments
          retry-on-snapshot-warnings: true
          retry-on-snapshot-warnings-timeout: 600
          base-ref: ${{ github.event.inputs.base_ref || '' }}
          head-ref: ${{ github.event.inputs.head_ref || '' }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
