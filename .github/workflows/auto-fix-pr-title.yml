name: Auto-fix PR Title

on:
  pull_request_target:
    types: [opened, reopened, edited, synchronize]

permissions:
  pull-requests: write
  contents: read

jobs:
  auto-fix: 
    runs-on: ubuntu-latest
    steps:
      - name: Auto-add conventional commit prefix
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const prTitle = context.payload.pull_request.title;
            const prNumber = context.payload.pull_request.number;
            const branchName = context.payload.pull_request.head.ref.toLowerCase();
            
            // –°–ø–∏—Å–æ–∫ –≤–∞–ª—ñ–¥–Ω–∏—Ö –ø—Ä–µ—Ñ—ñ–∫—Å—ñ–≤
            const validTypes = ['feat', 'fix', 'docs', 'refactor', 'perf', 'test', 'chore', 'ci', 'build', 'revert'];
            
            // –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —á–∏ —î –≤–∂–µ –ø—Ä–µ—Ñ—ñ–∫—Å
            const hasPrefix = validTypes.some(type => {
              const regex = new RegExp(`^${type}(\\(.+\\))?:\\s`, 'i');
              return regex.test(prTitle);
            });
            
            if (hasPrefix) {
              console.log(`‚úÖ PR #${prNumber} –≤–∂–µ –º–∞—î –≤–∞–ª—ñ–¥–Ω–∏–π –ø—Ä–µ—Ñ—ñ–∫—Å`);
              return;
            }
            
            // –Ü–Ω—Ç–µ–ª–µ–∫—Ç—É–∞–ª—å–Ω–µ –≤–∏–∑–Ω–∞—á–µ–Ω–Ω—è —Ç–∏–ø—É
            let prefix = 'chore'; // default
            
            if (branchName.includes('feat') || branchName.includes('feature')) {
              prefix = 'feat';
            } else if (branchName.includes('fix') || branchName.includes('bug') || branchName.includes('hotfix')) {
              prefix = 'fix';
            } else if (branchName.includes('doc')) {
              prefix = 'docs';
            } else if (branchName.includes('test')) {
              prefix = 'test';
            } else if (branchName.includes('ci') || branchName.includes('workflow')) {
              prefix = 'ci';
            } else if (branchName.includes('refactor')) {
              prefix = 'refactor';
            } else if (branchName.includes('perf')) {
              prefix = 'perf';
            }
            
            // –í–∏–∑–Ω–∞—á–µ–Ω–Ω—è –∑–∞ –∫–ª—é—á–æ–≤–∏–º–∏ —Å–ª–æ–≤–∞–º–∏ –≤ —Ç–∏—Ç—É–ª—ñ
            const lowerTitle = prTitle.toLowerCase();
            if (lowerTitle.includes('add') || lowerTitle.includes('implement') || lowerTitle.includes('create')) {
              prefix = 'feat';
            } else if (lowerTitle.includes('fix') || lowerTitle.includes('bug') || lowerTitle.includes('resolve')) {
              prefix = 'fix';
            } else if (lowerTitle.includes('update') || lowerTitle.includes('upgrade')) {
              prefix = 'chore';
            } else if (lowerTitle.includes('remove') || lowerTitle.includes('delete')) {
              prefix = 'chore';
            } else if (lowerTitle.includes('doc')) {
              prefix = 'docs';
            }
            
            const newTitle = `${prefix}: ${prTitle}`;
            
            try {
              await github.rest.pulls.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: prNumber,
                title: newTitle
              });
              
              // –î–æ–¥–∞—Ç–∏ –∫–æ–º–µ–Ω—Ç–∞—Ä –ø—Ä–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω—É –∑–º—ñ–Ω—É
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body: `ü§ñ –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –¥–æ–¥–∞–Ω–æ –ø—Ä–µ—Ñ—ñ–∫—Å \`${prefix}:\` –¥–æ —Ç–∏—Ç—É–ª—É PR –¥–ª—è –≤—ñ–¥–ø–æ–≤—ñ–¥–Ω–æ—Å—Ç—ñ [Conventional Commits](https://www.conventionalcommits.org/).\n\n–ü–æ–ø–µ—Ä–µ–¥–Ω—ñ–π —Ç–∏—Ç—É–ª: \`${prTitle}\`\n–ù–æ–≤–∏–π —Ç–∏—Ç—É–ª: \`${newTitle}\`\n\n–Ø–∫—â–æ –ø—Ä–µ—Ñ—ñ–∫—Å –Ω–µ–≤—ñ—Ä–Ω–∏–π, –≤—ñ–¥—Ä–µ–¥–∞–≥—É–π—Ç–µ —Ç–∏—Ç—É–ª –≤—Ä—É—á–Ω—É.`
              });
              
              console.log(`‚úÖ –û–Ω–æ–≤–ª–µ–Ω–æ —Ç–∏—Ç—É–ª PR #${prNumber}: "${newTitle}"`);
            } catch (error) {
              console.error(`‚ùå –ü–æ–º–∏–ª–∫–∞ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è PR: ${error.message}`);
            }
